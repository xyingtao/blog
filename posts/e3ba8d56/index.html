<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>MySQL高级(二)--性能分析和优化 | 樱桃先生</title><meta name="author" content="樱桃先生"><meta name="copyright" content="樱桃先生"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="性能分析MySQL Query Optimizer MySQL中有专门负责优化SELECT语句的优化器模块,主要功能: 通过计算分析系统中收集到的统计信息,为客户端请求的Query提供他认为最优的执行计划(他认为最优的数据检索方式,但不见得是DBA认为是最优的,这部分最耗费时间) 当客户端项MySQL请求一条Query,命令解析器模块完成请求分类,区别出是SELECT并转发给MySQL Query">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL高级(二)--性能分析和优化">
<meta property="og:url" content="http://example.com/posts/e3ba8d56/index.html">
<meta property="og:site_name" content="樱桃先生">
<meta property="og:description" content="性能分析MySQL Query Optimizer MySQL中有专门负责优化SELECT语句的优化器模块,主要功能: 通过计算分析系统中收集到的统计信息,为客户端请求的Query提供他认为最优的执行计划(他认为最优的数据检索方式,但不见得是DBA认为是最优的,这部分最耗费时间) 当客户端项MySQL请求一条Query,命令解析器模块完成请求分类,区别出是SELECT并转发给MySQL Query">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typoratimg.jpeg">
<meta property="article:published_time" content="2020-09-09T07:10:00.000Z">
<meta property="article:modified_time" content="2022-08-27T09:49:53.160Z">
<meta property="article:author" content="樱桃先生">
<meta property="article:tag" content="MySQL">
<meta property="article:tag" content="索引">
<meta property="article:tag" content="优化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typoratimg.jpeg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MySQL高级(二)--性能分析和优化",
  "url": "http://example.com/posts/e3ba8d56/",
  "image": "https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typoratimg.jpeg",
  "datePublished": "2020-09-09T07:10:00.000Z",
  "dateModified": "2022-08-27T09:49:53.160Z",
  "author": [
    {
      "@type": "Person",
      "name": "樱桃先生",
      "url": "http://example.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/posts/e3ba8d56/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MySQL高级(二)--性能分析和优化',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2022/08/20/hk9Zvq4YRsIcnrw.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">78</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">65</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-camera"></i><span> 图库</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typoratimg.jpeg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">樱桃先生</span></a><a class="nav-page-title" href="/"><span class="site-name">MySQL高级(二)--性能分析和优化</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-camera"></i><span> 图库</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">MySQL高级(二)--性能分析和优化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-09-09T07:10:00.000Z" title="发表于 2020-09-09 15:10:00">2020-09-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-08-27T09:49:53.160Z" title="更新于 2022-08-27 17:49:53">2022-08-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/MySQL/">MySQL</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="性能分析"><a href="#性能分析" class="headerlink" title="性能分析"></a>性能分析</h1><h2 id="MySQL-Query-Optimizer"><a href="#MySQL-Query-Optimizer" class="headerlink" title="MySQL Query Optimizer"></a>MySQL Query Optimizer</h2><ul>
<li>MySQL中有专门负责优化SELECT语句的<strong>优化器模块</strong>,主要功能: 通过计算分析系统中收集到的统计信息,为客户端请求的Query提供他认为最优的执行计划(他认为最优的数据检索方式,但不见得是DBA认为是最优的,这部分最耗费时间)</li>
<li>当客户端项MySQL请求一条<strong>Query</strong>,命令解析器模块完成<strong>请求分类</strong>,区别出是SELECT并转发给<strong>MySQL Query Optimizer</strong>时,MySQL Query Optimizer首先会对整条Query进行<strong>优化</strong>,处理掉一些常量表达式的预算,直接换算成常量值.并对Query中的查询条件进行简化和转换,如去掉一些无用或显而易见的条件,结构调整等,然后分析Query中的<strong>Hint信息</strong>(如果有),看显示Hint信息是否可以完全确定该Query的执行计划.如果没有Hint或Hint信息还不足以完全确定执行计划,则会读取<strong>所涉及对象的统计信息</strong>,根据Query进行相应的计算分析再得出最后的执行计划.</li>
</ul>
<h2 id="MySQL常见瓶颈"><a href="#MySQL常见瓶颈" class="headerlink" title="MySQL常见瓶颈"></a>MySQL常见瓶颈</h2><ul>
<li>CPU: CPU在饱和的时候一般发生在数据装入内存或从磁盘上读取数据时候</li>
<li>IO: 磁盘I&#x2F;O瓶颈发生在装入数据远大于内存容量的时候</li>
<li>服务器硬件的性能瓶颈: top,free,iostat和vmstat来查看系统的性能状态</li>
</ul>
<h2 id="Explain"><a href="#Explain" class="headerlink" title="Explain"></a>Explain</h2><h3 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h3><p>使用EXPLAIN关键字可以模拟优化器执行SQL查询语句,从而知道MySQL是如何处理你的SQL语句的,分析你的查询语句或者是表结构的性能瓶颈</p>
<h3 id="能干嘛"><a href="#能干嘛" class="headerlink" title="能干嘛"></a>能干嘛</h3><ul>
<li>表的读取顺序</li>
<li>数据读取操作的操作类型</li>
<li>哪些索引可以使用</li>
<li>哪些索引被实际使用</li>
<li>表之间的引用</li>
<li>每张表有多少行被优化器查询</li>
</ul>
<h3 id="怎么玩"><a href="#怎么玩" class="headerlink" title="怎么玩"></a>怎么玩</h3><ul>
<li>Explain+SQL语句</li>
<li>执行计划包含的信息有<ul>
<li>id</li>
<li>select_type</li>
<li>table</li>
<li>type</li>
<li>possible_keys</li>
<li>key</li>
<li>key_len</li>
<li>ref</li>
<li>rows</li>
<li>Extra</li>
</ul>
</li>
</ul>
<h4 id="id"><a href="#id" class="headerlink" title="id:"></a>id:</h4><p>select查询的序列号,包含一组数字,表示查询中执行select子句或操作表的顺序</p>
<ul>
<li>id 相同 执行顺序由上而下</li>
<li>id 不同 如果是子查询 id的序号会递增 id值越大优先级越高 越先被执行</li>
<li>id相同不同同时存在</li>
</ul>
<h4 id="select-type"><a href="#select-type" class="headerlink" title="select_type:"></a>select_type:</h4><ol>
<li><strong>SIMPLE</strong>  -简单的select查询 查询中不包含子查询或者UNION</li>
<li><strong>PRIMARY</strong> -查询中若包含任何复杂的子部分,最外层查询则被标记为</li>
<li><strong>SUBQUERY</strong>  -在select或where列表中包含子查询</li>
<li><strong>DERIVED</strong>  -在FROM列表中包含的子查询被标记为 DERIVED(衍生) mysql会递归执行这些子查询把结果放在临时表</li>
<li><strong>UNION</strong>  -若第二个select出现union之后,则被标记为union 若union包含在from子句的子查询中,外层select将被标记为;DERIVED</li>
<li><strong>UNION RESULT</strong>  -从union表获取结果的select</li>
</ol>
<h4 id="table"><a href="#table" class="headerlink" title="table:"></a>table:</h4><p>显示这一行是关于哪张表的</p>
<h4 id="type"><a href="#type" class="headerlink" title="type:"></a>type:</h4><p>type显示的是访问类型,是较为重要的指标 常用的结果值从好到坏如下:</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/xyingtao/blogimage/raw/master/img/image-20200909112331920.png" alt="image-20200909112331920"></p>
<ul>
<li><p><strong>system</strong></p>
<p>表只有一行记录(等于系统表) 这是const的特例 平时不会出现</p>
</li>
<li><p><strong>const</strong></p>
<p>表示通过索引一次就找到,const用于比较primary key或者unique索引,因为只匹配一行数据所以很快</p>
<p>如将主键置于where表中,mysql就能将该表查询转换成一个常量</p>
</li>
<li><p><strong>eq_ref</strong></p>
<p>唯一性索引扫描,对于整个索引键,表中只有一条记录与之匹配,常见于主键成唯一索引扫描</p>
</li>
<li><p><strong>ref</strong></p>
<p>非唯一性索引扫描,返回匹配某个单独值的所有行</p>
<p>本质上也是一种索引访问,它返回所有匹配某个单独值的行,然而可能会找到多个符合条件的行,所以它应该属于查找和扫描的混合体</p>
</li>
<li><p><strong>range</strong></p>
<p>只检索给定范围的行,使用一个索引来选择行,key列显示了使用的索引</p>
<p>一般就是在你的where语句中出现了<code>between</code>,<code>&lt;</code>,<code>&gt;</code>,<code>in</code>等的查询</p>
<p>这种范围扫描索引比全网扫描好,因为只需要开始于索引的某一点,而结束于另一点,不用扫描全部索引</p>
</li>
<li><p><strong>index</strong></p>
<p><code>Full Index Scan index</code>和all区别是:index类型只遍历索引树,这通常比All快,因为索引文件通常比数据文件小</p>
<p>(all index都是读取全表 但index从索引读取 all从硬盘读取)</p>
</li>
<li><p><strong>all</strong></p>
<p><code>Full Table Scan</code>遍历全表</p>
</li>
<li><p>一般来说要至少达到range级别,最好到ref</p>
</li>
</ul>
<h4 id="possible-keys"><a href="#possible-keys" class="headerlink" title="possible_keys:"></a>possible_keys:</h4><p>显示可能应用在这张表中的索引,一个或者多个.查询涉及到的字段上若存在索引,则该索引将被列出,但不一定被实际查询使用</p>
<h4 id="key"><a href="#key" class="headerlink" title="key:"></a>key:</h4><ul>
<li>实际使用的索引 如果为null则没有使用索引</li>
<li>查询中如果使用了覆盖索引 则该索引和查询的select字段重叠</li>
</ul>
<h4 id="key-len"><a href="#key-len" class="headerlink" title="key_len:"></a>key_len:</h4><ul>
<li>表示索引中使用的字节数 可通过计算查询使用索引的长度 在不损失精确性的情况下 长度越短越好</li>
<li>key_len显示的值为索引字段的最大可能长度,并非实际使用长度,即key_len是根据表定义计算而得,不是通过表内检索出的</li>
</ul>
<h4 id="ref"><a href="#ref" class="headerlink" title="ref:"></a>ref:</h4><p>显示索引的哪一列被使用了,如果可能的话  是一个常数,哪些列或常量被用于查找索引列上的值</p>
<h4 id="rows"><a href="#rows" class="headerlink" title="rows:"></a>rows:</h4><p>根据表统计信息以及索引选用情况,大致估算出找到所需记录所需读取的行数</p>
<h4 id="Extra"><a href="#Extra" class="headerlink" title="Extra:"></a>Extra:</h4><p>包含不适合在其它列中显示但是十分重要的额外信息</p>
<ol>
<li><p><strong>Using filesort</strong>: 说明msql会对数据使用一个外部的索引排序,而不是按照表内的索引顺序读取.mysql中无法利用索引完成的排序操作称为”文件排序”</p>
</li>
<li><p><strong>Using temporary</strong>: 使用了临时表保存中间结果 常见于排序<code>order by</code>和<code>group by</code></p>
</li>
<li><p><strong>Using index:</strong> </p>
<p>表示相应的select操作中使用了覆盖索引,避免了访问表的数据行 效率不错</p>
<p>如果同时出现using where,表明索引被用来执行索引键值的查找</p>
<p>如果没有同时出现using where 表明索引用来读取数据而非执行查找动作</p>
<p><strong>覆盖索引</strong>:</p>
<blockquote>
<p>覆盖索引(Covering Index) 一说为索引覆盖</p>
<p>就是select字段只用从索引中就能取得 不必读取数据行 MySQL可以利用索引返回select列表中的字段 而不必根据索引再次读取数据文件 换句话说 <strong>查询列表被所建的索引覆盖</strong></p>
<p>如果要使用覆盖索引 一定要注意select列表中只取出需要的列 不可以使用**select * **</p>
<p>如果将所有字段一起做索引将导致索引文件过大查询性能下降</p>
</blockquote>
</li>
<li><p>Using where: 使用了where</p>
</li>
<li><p>Using join buffer: 使用了连接缓存</p>
</li>
<li><p>impossible where: where子句的值总是false,不能用来获取任何元组</p>
</li>
<li><p>select tables optimized away :</p>
<p>在没有groupby子句的情况下 基于索引优化min&#x2F;max操作或者对于MySIAM存储引擎优化COUNT(*)操作 不必等到执行阶段再进行计算 查询执行计划生成的阶段即完成优化</p>
</li>
<li><p>distinct: 优化distinct操作 在找到第一匹配的元组后即停止找同样值的动作</p>
</li>
</ol>
<h1 id="索引优化"><a href="#索引优化" class="headerlink" title="索引优化"></a>索引优化</h1><h2 id="索引分析"><a href="#索引分析" class="headerlink" title="索引分析"></a>索引分析</h2><h3 id="单表"><a href="#单表" class="headerlink" title="单表"></a>单表</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typoraimage-20200717093752691.png" alt="image-20200717093752691"></p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typoraimage-20200717094034739.png" alt="image-20200717094034739"></p>
<p>范围 索引无法用到</p>
<p>解决办法 只建 categoryId和views 两个索引 </p>
<h3 id="两表"><a href="#两表" class="headerlink" title="两表"></a>两表</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM class LEFT JOIN book ON class.card=book.card</span><br><span class="line"># 结论 type 有ALL</span><br><span class="line"># 建立右表索引 all--&gt;ref </span><br></pre></td></tr></table></figure>

<p>左连接特性:左边一定都有 所以建立索引的关键在右表</p>
<h3 id="三表"><a href="#三表" class="headerlink" title="三表"></a>三表</h3><p>建两个表的索引</p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>尽可能减少join语句中<code>NestedLoop</code>的循环总次数 永远用小结果集驱动大的结果集</p>
<p>优先优化<code>NestedLoop</code>的内层循环</p>
<p>保证<code>join</code>语句中被驱动表上的<code>join</code>条件字段已经被索引 </p>
<p>当无法保证被驱动表的<code>join</code>条件字段被索引且内存资源充足的前提下 不要太吝啬<code>joinBuffer</code>的设置</p>
<h3 id="索引失效的情况-应该避免"><a href="#索引失效的情况-应该避免" class="headerlink" title="索引失效的情况(应该避免)"></a>索引失效的情况(应该避免)</h3><ul>
<li><p>全值匹配</p>
</li>
<li><p><strong>最佳左前缀</strong>法则：</p>
<p>指的是查询从索引的最左前列开始并且不跳过索引中的列</p>
</li>
<li><p>不在<strong>索引列</strong>上进行任何操作(计算 函数 自动手动类型转换),如果做了 会导致<strong>索引失效</strong></p>
</li>
<li><p>存储引擎不能使用索引中范围条件的右边的列</p>
</li>
<li><p>尽量使用覆盖索引,减少 **select ***</p>
</li>
<li><p>mysql在使用 <code>!=</code> 或 <code>&lt;&gt;</code>无法使用索引 会导致全表扫描</p>
</li>
<li><p>is null,is not null也无法使用索引</p>
</li>
<li><p>like以通配符开头(‘<code>%abc...</code>‘) 索引失效</p>
<p>like 百分号最好加在右边 其余位置导致索引失效</p>
</li>
<li><p>字符串（varchar类型 ）不加单引号 索引失效</p>
</li>
<li><p>少用<code>or</code> 用or连接索引失效</p>
</li>
</ul>
<h3 id="一般性建议"><a href="#一般性建议" class="headerlink" title="一般性建议:"></a>一般性建议:</h3><ul>
<li>对于单键索引,尽量选择针对当前query过滤性更好的索引</li>
<li>在选择组合索引的时候,当前Query中过滤性最好的字段在索引字段顺序中,位置越靠前越好</li>
<li>在选择组合索引的时候,尽量选择可以能够包含当前query中的where字句中更多字段的索引</li>
<li>尽可能通过分析统计信息和调整query的写法来达到选择合适索引的目的</li>
</ul>
<h3 id="优化步骤总结"><a href="#优化步骤总结" class="headerlink" title="优化步骤总结"></a>优化步骤总结</h3><p>优化总结口诀.. (这完全不押韵………)</p>
<p>全值匹配我最爱,最左前缀要遵守</p>
<p>带头大哥不能死,中间兄弟不能断</p>
<p>索引列上少计算,范围之后全失效</p>
<p>like百分写最右,覆盖索引不写星</p>
<p>不等空值还有or,索引失效要少用</p>
<h1 id="查询截取分析"><a href="#查询截取分析" class="headerlink" title="查询截取分析"></a>查询截取分析</h1><h2 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h2><h3 id="永远小表驱动大表-类似-nested-loop"><a href="#永远小表驱动大表-类似-nested-loop" class="headerlink" title="永远小表驱动大表(类似 nested loop)"></a>永远小表驱动大表(类似 <code>nested loop</code>)</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typoraimage-20200720083359021.png" alt="image-20200720083359021"></p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/xyingtao/blogimage/raw/master/img/image-20200720083437424.png" alt="image-20200720083437424"></p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typoraimage-20200720083540695.png" alt="image-20200720083540695"></p>
<h3 id="order-by优化"><a href="#order-by优化" class="headerlink" title="order by优化:"></a>order by优化:</h3><ul>
<li><p>尽量使用index方式排序 避免使用filesort</p>
</li>
<li><p>order by满足两情况 使用index:</p>
<ol>
<li>order by 使用索引最左前列</li>
<li>使用where和order by组合满足索引最左前列</li>
</ol>
</li>
<li><p>尽量在索引列上完成排序操作,遵照索引最佳左前列</p>
</li>
<li><p>如果不在索引列上 filesort有两种算法 mysql就要启动 <code>双路排序</code>和<code>单路排序</code></p>
<ul>
<li><p><strong>双路排序</strong>:mysql4.1 以前使用 双路排序 字面意思就是两次扫描磁盘 最终获取数据</p>
<p>读取行指针和orderby列 对他们进行排序 然后扫描已经排序好的列表 按照列表的值重新从列表中读取对应数据输出</p>
<p>从磁盘读取排序字段,在buffer进行排序,再从磁盘取其它字段</p>
</li>
<li><p><strong>单路排序</strong>:从磁盘重新读取需要的列,按照order by列在buffer排序,然后扫描排序后的列表进行输出,它的效率会更快一点,避免了第二次读取数据.并且把随机IO变成了顺序IO,但是他会使用更多的空间,因为把每一行都保存在内存中了</p>
</li>
<li><p>由于单路是后出的 总体而言好过双路 但是单路有存在问题…</p>
</li>
</ul>
</li>
<li><p>优化策略:</p>
<ul>
<li>增大sort_buffer_size参数的设置</li>
<li>增大max_length_for_sort_data参数的设置</li>
<li><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/xyingtao/blogimage/raw/master/img/image-20200720091217561.png" alt="image-20200720091217561"></li>
<li><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typoraimage-20200720091645124.png" alt="image-20200720091645124"></li>
</ul>
</li>
</ul>
<h3 id="Group-by优化"><a href="#Group-by优化" class="headerlink" title="Group by优化:"></a>Group by优化:</h3><ul>
<li>group by实质是先排序后进行分组 遵照索引建立的最佳左前缀</li>
<li>当无法使用索引列时 ,增大sort_buffer_size参数的设置+增大max_length_for_sort_data参数的设置</li>
<li>where高于having 能写在where就不去having限定</li>
</ul>
<h2 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h2><h3 id="是什么-1"><a href="#是什么-1" class="headerlink" title="是什么"></a>是什么</h3><ul>
<li>MySQL的慢查询日志 是MySQL提供的一种日志记录,它用来记录在MySQL中响应时间超过阈值的语句,具体指运行时间超过<code>long_query_time</code>值的SQL,就会被记录到慢查询日志中</li>
<li><code>long_query_time</code>的值默认是10秒</li>
</ul>
<h3 id="怎么玩-1"><a href="#怎么玩-1" class="headerlink" title="怎么玩"></a>怎么玩</h3><ul>
<li><p>默认情况下 MySQL数据库没有开启慢查询日志 我们需要手动来设置这个参数</p>
<p>默认情况下 slow_query_log的值为OFF,表示禁用慢查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#x27;%slow_query_log%&#x27;;</span><br><span class="line">set global slow_query_log=1;</span><br><span class="line">#只对当前数据库生效 MySQL重启失效</span><br></pre></td></tr></table></figure>

<p>如果要永久生效,必须修改my.cnf文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">在[mysqld]下增加或修改</span><br><span class="line">slow_query_log=1;</span><br><span class="line">#系统默认指定 一个 host_name=slow.log</span><br><span class="line">slow_query_log_file=/var/lib/mysql/XXX-slow.log</span><br><span class="line">#重启mysql服务</span><br></pre></td></tr></table></figure>
</li>
<li><p>当然 如果不是调优需要 一般不开启 会带来或多或少的性能影响</p>
</li>
<li><p>慢查询日志支持将日志写入文件</p>
</li>
<li><p><strong>日志分析工具mysqldumpslow</strong></p>
<ul>
<li><p>查看mysqldumpslow的帮助信息</p>
<p>s:何种方式排序</p>
<p>c:访问次数</p>
<p>l:锁定时间</p>
<p>r:返回记录</p>
<p>t:查询时间</p>
<p>al:平均锁定时间</p>
<p>ar:平均返回记录数</p>
<p>at:平均查询时间</p>
<p>t:返回前面多少条数据</p>
<p>g:后边搭配一个正则匹配模式 大小写不敏感</p>
</li>
<li><p>常用命令</p>
<p>得到返回记录集最多的10个sql</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldumpslow -s r -t 10 /var/lib/mysql/XXX-slow.log</span><br></pre></td></tr></table></figure>

<p>得到访问次数最多的10个sql</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldumpslow -s c -t 10 /var/lib/mysql/XXX-slow.log</span><br></pre></td></tr></table></figure>

<p>得到按照时间排序前十条里含有左连接的查询语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldumpslow -s t -t 10 -g &quot;left join&quot; /var/lib/mysql/XXX-slow.log</span><br></pre></td></tr></table></figure>

<p>建议使用的时候结合<code>|</code>和<code>more</code>一起使用 否则可能出现爆屏情况</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldumpslow -s r -t 10 /var/lib/mysql/XXX-slow.log |more</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="批量创建数据用于测试"><a href="#批量创建数据用于测试" class="headerlink" title="批量创建数据用于测试"></a>批量创建数据用于测试</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typoraimage-20200909143247391.png" alt="image-20200909143247391"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line">CREATE FUNCTION rand_string(n INT) RETURNS VARCHAR(255)</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE chars_str VARCHAR(100) DEFAULT &#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;;</span><br><span class="line">DECLARE return_str VARCHAR(255) DEFAULT &#x27;&#x27;;</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">WHILE i &lt; n DO</span><br><span class="line">SET return_str = CONCAT(return_str,SUBSTRING(chars_str,FLOOR(1+RAND()*52),1));</span><br><span class="line">SET i = i+1;</span><br><span class="line">END WHILE;</span><br><span class="line">RETURN return_str;</span><br><span class="line">END $$</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DELIMITER $$</span><br><span class="line">CREATE FUNCTION ranf_num() RETURNS INT(5)</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">SET i = FLOOR(100+RAND()*10);</span><br><span class="line">RETURN i;</span><br><span class="line">END $$</span><br><span class="line"></span><br><span class="line">批量传入</span><br><span class="line">DELIMITER $$</span><br><span class="line">CREATE PROCEDURE insert_emp(IN START INT(10),IN max_num INT(10))</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">SET autocommit = 0;</span><br><span class="line">REPEAT</span><br><span class="line">SET i = i+1;</span><br><span class="line">INSERT INTO emp(empno,ename,job,mgr,hiredate,sal,comm,deptno)VALUES((START+i),rand_string(6),&#x27;SALESMAN&#x27;,0001,CURDATE(),2000.400,rand_num());</span><br><span class="line">UNTIL i = max_num</span><br><span class="line">END REPEAT;</span><br><span class="line">COMMIT;</span><br><span class="line">END $$</span><br><span class="line"></span><br><span class="line">DELIMITER $$</span><br><span class="line">CREATE PROCEDURE insert_dept(IN START INT(10),IN max_num INT(10))</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">SET autocommit = 0;</span><br><span class="line">REPEAT</span><br><span class="line">SET i = i+1;</span><br><span class="line">INSERT INTO dept(deptno,dname,loc)VALUES((START+i),rand_string(10),rand_string(8));</span><br><span class="line">UNTIL i = max_num</span><br><span class="line">END REPEAT;</span><br><span class="line">COMMIT;</span><br><span class="line">END $$</span><br></pre></td></tr></table></figure>

<h2 id="show-profile"><a href="#show-profile" class="headerlink" title="show profile"></a>show profile</h2><h3 id="是什么-2"><a href="#是什么-2" class="headerlink" title="是什么:"></a>是什么:</h3><p>mysql提供的可以用来分析当前会话中语句执行的资源消耗情况,可以用于sql的调优测量</p>
<p>默认情况下 参数处于关闭情况 并保存最近15次的运行结果</p>
<h3 id="分析步骤："><a href="#分析步骤：" class="headerlink" title="分析步骤："></a>分析步骤：</h3><ol>
<li><p>是否支持:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#x27;profiling&#x27;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">或者</span></span><br><span class="line">show variables like &#x27;profiling%&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用前先开启</p>
</li>
<li><p>运行 sql之后 查看结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show profiles;</span><br></pre></td></tr></table></figure>
</li>
<li><p>诊断 <strong>showprofile cpu,block io for query [id]</strong> </p>
<p>id是上一步问题的数字号码</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typoraimage-20200720122505144.png" alt="image-20200720122505144"></p>
</li>
<li><p>日常主要关注四个</p>
<ol>
<li>converting HEAP to MySIAM查询结果太大 ,内存不够用了往磁盘上搬了</li>
<li>creating tmp table 创建临时表:拷贝数据到临时表 用完删除</li>
<li>copying to tmp table on disk 把内存中临时表复制到磁盘,危险!</li>
<li>locked</li>
</ol>
</li>
</ol>
<h2 id="全局查询日志"><a href="#全局查询日志" class="headerlink" title="全局查询日志"></a>全局查询日志</h2><h3 id="配置启用"><a href="#配置启用" class="headerlink" title="配置启用"></a>配置启用</h3><p>在mysql的my.cnf中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">general_log=1;</span><br><span class="line">general_log_file=/path/logfile</span><br><span class="line">log_output=file;</span><br></pre></td></tr></table></figure>

<h3 id="编码启用"><a href="#编码启用" class="headerlink" title="编码启用"></a>编码启用</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set global general_log=1;</span><br><span class="line">set global log_output=&#x27;table&#x27;;</span><br></pre></td></tr></table></figure>

<p>此后所编写的sql都会记录到mysql库里面的general_log表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看</span></span><br><span class="line">select * from mysql.general_log;</span><br></pre></td></tr></table></figure>

<h3 id="永远不要在生产环境开启"><a href="#永远不要在生产环境开启" class="headerlink" title="永远不要在生产环境开启"></a>永远不要在生产环境开启</h3><h2 id="一般的的优化流程"><a href="#一般的的优化流程" class="headerlink" title="一般的的优化流程"></a>一般的的优化流程</h2><ul>
<li>分析<ol>
<li>观察 至少跑一天 看看生产的慢SQL的情况</li>
<li>开启慢查询日志 设置阈值 抓取出sql</li>
<li>explain+慢sql分析</li>
<li>show profiles;</li>
<li>运维经理 DBA 进行数据库服务器的参数调优</li>
</ol>
</li>
</ul>
<p>资料参考: 尚硅谷</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">樱桃先生</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/posts/e3ba8d56/">http://example.com/posts/e3ba8d56/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://example.com" target="_blank">樱桃先生</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MySQL/">MySQL</a><a class="post-meta__tags" href="/tags/%E7%B4%A2%E5%BC%95/">索引</a><a class="post-meta__tags" href="/tags/%E4%BC%98%E5%8C%96/">优化</a></div><div class="post-share"><div class="social-share" data-image="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typoratimg.jpeg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://s2.loli.net/2022/08/21/Ay5sujrkH1nLTwW.jpg" target="_blank"><img class="post-qr-code-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2022/08/21/Ay5sujrkH1nLTwW.jpg" alt="Wechat"/></a><div class="post-qr-code-desc">Wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/f5f9fa9b/" title="Docker"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typorau=2532140561,3610048596&amp;fm=26&amp;gp=0.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Docker</div></div><div class="info-2"><div class="info-item-1"> 常用命令直接跳至”Docker的常用命令” 查询常用命令直接跳至”Docker的常用命令” 配置阿里云镜像: yum-config-manager –add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 前面章节为官方文档翻译 后面为常用操作和自启设置  Docker是什么？系统平滑移植，容器虚拟化技术 Docker 是一个开源项目，诞生于 2013 年初，最初是 dotCloud 公司内部的一个业余项目。它基于 Google 公司推出的 Go 语言实现。 项目后来加入了 Linux 基金会，遵从了 Apache 2.0 协议，项目代码在 GitHub 上进行维护。 Docker 自开源后受到广泛的关注和讨论，以至于 dotCloud 公司后来都改名为 Docker Inc。Redhat 已经在其 RHEL6.5 中集中支持 Docker；Google 也在其 PaaS 产品中广泛应用。 Docker 项目的目标是实现轻量级的操作系统虚拟化解决方案。 Docker 的基础是 **Linu...</div></div></div></a><a class="pagination-related" href="/posts/af9dc3a7/" title="MySQL高级(一)--索引"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typoratimg.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">MySQL高级(一)--索引</div></div><div class="info-2"><div class="info-item-1">MySQL高级(一)–索引 mysql基础部分增删改那些笔记当时全做在 marginNote思维导图上 现在反而觉得不方便了 … 以后再看看要不要搬过来  高级部分内容挺多的 为了提高 阅读效果 把以前偷懒截得图 大量手动码出来…  linux下安装目录    路径 解释 备注    &#x2F;var&#x2F;lib&#x2F;mysql&#x2F; mysql数据库文件的存放路径 &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;atguigu.cloud.pid   &#x2F;usr&#x2F;share&#x2F;mysql 配置文件目录 mysql.server命令及配置文件   &#x2F;usr&#x2F;bin 相关命令目录 mysqladmin mysqldump等命令   &#x2F;etc&#x2F;init.d&#x2F;mysql 启停相关脚本    修改默认的配置文件5.5 版本 :&#x2F;usr&#x2F;share&#x2F;mysql&#x2F;my-huge.cnf    &#x2F;etc&#x2F;my.cnf ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/af9dc3a7/" title="MySQL高级(一)--索引"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typoratimg.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-08</div><div class="info-item-2">MySQL高级(一)--索引</div></div><div class="info-2"><div class="info-item-1">MySQL高级(一)–索引 mysql基础部分增删改那些笔记当时全做在 marginNote思维导图上 现在反而觉得不方便了 … 以后再看看要不要搬过来  高级部分内容挺多的 为了提高 阅读效果 把以前偷懒截得图 大量手动码出来…  linux下安装目录    路径 解释 备注    &#x2F;var&#x2F;lib&#x2F;mysql&#x2F; mysql数据库文件的存放路径 &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;atguigu.cloud.pid   &#x2F;usr&#x2F;share&#x2F;mysql 配置文件目录 mysql.server命令及配置文件   &#x2F;usr&#x2F;bin 相关命令目录 mysqladmin mysqldump等命令   &#x2F;etc&#x2F;init.d&#x2F;mysql 启停相关脚本    修改默认的配置文件5.5 版本 :&#x2F;usr&#x2F;share&#x2F;mysql&#x2F;my-huge.cnf    &#x2F;etc&#x2F;my.cnf ...</div></div></div></a><a class="pagination-related" href="/posts/3c07f04c/" title="MySQL常见错误"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typoratimg.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-23</div><div class="info-item-2">MySQL常见错误</div></div><div class="info-2"><div class="info-item-1">MySQL常见错误2059 原因:  mysql8之前的版本中加密规则为mysql_native_password，而在mysql8以后的加密规则为caching_sha2_password。 解决办法 将mysql用户登录的加密规则修改为mysql_native_password  用管理员权限打开 CMD  1mysql -u root -p #进入数据库   修改加密规则及密码，刷新即可；  123ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;你的密码&#x27; PASSWORD EXPIRE NEVER; #修改加密规则ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED WITH mysql_native_password BY &#x27;你的密码&#x27;; #修改密码FLUSH PRIVILEGES; #刷新数据  The server time zone在数据库配置中添加默认时区：  找到mysql...</div></div></div></a><a class="pagination-related" href="/posts/bce68613/" title="MySQL基础"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typoratimg.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-20</div><div class="info-item-2">MySQL基础</div></div><div class="info-2"><div class="info-item-1">MySQL基础数据库概述什么是数据库数据库是持久化的一种介质,可以理解成用来存储和管理数据的仓库 持久化: 把数据保存到可掉电式存储设备中以供之后使用. 持久化的大多数时候是将内存中的数据存储在数据库中,当然也可以存储在磁盘文件,XML数据文件中 为什么使用数据库 可将数据持久化到硬盘 可存储大量数据 方便检索 保证数据的一致性,完整性 安全,可共享 通过组合分析,可以产生新数据  常见数据库场景 Oracle: 甲骨文 DB2: IBM SQL Server: 微软 MySQL: 甲骨文  数据库相关概念 DB:  数据库(Database): 存储数据的”仓库”.它保存了一系列有组织的数据  DBMS 数据库管理系统(Database Management System).数据库是通过DBMS创建和操作的容器  SQL 结构化查询语言(Structure Query Language): 专门用来与数据库通信的语言   数据库存储数据的特点 将数据放到表中,表再放到库中  一个数据库中可以有多个表,每一个表都有一个名字,用来标识自己 表名具有唯一性  表具有一些特性,这些特性...</div></div></div></a><a class="pagination-related" href="/posts/c41e9d72/" title="MySQL高级(三)--锁机制"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typoratimg.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-22</div><div class="info-item-2">MySQL高级(三)--锁机制</div></div><div class="info-2"><div class="info-item-1">MySQL锁机制什么是锁锁是计算机协调多个进程或线程并发访问某一资源的机制. 在数据库中,除了传统的计算资源(如CPU,RAM,I&#x2F;O等)的争用外,数据也是一种供许多用户共享的资源.如何保证数据并发访问的一致性,有效性是所有数据库必须解决的问题.锁冲突也是影响数据库并发访问性能的一个重要因素.从这个角度来说,锁对数据库而言显得尤为重要,也更加复杂. 锁的分类从对数据操作的粒度分: 表锁,行锁 从对数据操作的类型(读&#x2F;写)分:  读锁(共享锁): 针对同一份数据,多个读操作可以同时进行而不会互相影响  如果session1加了一个读锁 session1可以查 无法更新 则同时也无法读另一个表 只要加了锁 session2 无法更新session1 加锁的表 只有等session1 解了锁 session2 自动解除阻塞   写锁(排他锁):  当前写操作没有完成前,它会阻断其他写锁和读锁  session1 加了写锁 可读可改 同时session2 不可读不可写    表锁:特点:偏向MyISAM存储引擎,开销小,加锁快;无死锁;锁定粒度大,发生锁冲突的概率最高...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2022/08/20/hk9Zvq4YRsIcnrw.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">樱桃先生</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">78</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">65</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typoraWechat.jpeg"><i class="fab fa-weixin"></i><span>加为好友</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎光临樱桃先生的博客🍒～</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">性能分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL-Query-Optimizer"><span class="toc-number">1.1.</span> <span class="toc-text">MySQL Query Optimizer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL%E5%B8%B8%E8%A7%81%E7%93%B6%E9%A2%88"><span class="toc-number">1.2.</span> <span class="toc-text">MySQL常见瓶颈</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Explain"><span class="toc-number">1.3.</span> <span class="toc-text">Explain</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.3.1.</span> <span class="toc-text">是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%BD%E5%B9%B2%E5%98%9B"><span class="toc-number">1.3.2.</span> <span class="toc-text">能干嘛</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E7%8E%A9"><span class="toc-number">1.3.3.</span> <span class="toc-text">怎么玩</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#id"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">id:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#select-type"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">select_type:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#table"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">table:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#type"><span class="toc-number">1.3.3.4.</span> <span class="toc-text">type:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#possible-keys"><span class="toc-number">1.3.3.5.</span> <span class="toc-text">possible_keys:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#key"><span class="toc-number">1.3.3.6.</span> <span class="toc-text">key:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#key-len"><span class="toc-number">1.3.3.7.</span> <span class="toc-text">key_len:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ref"><span class="toc-number">1.3.3.8.</span> <span class="toc-text">ref:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rows"><span class="toc-number">1.3.3.9.</span> <span class="toc-text">rows:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Extra"><span class="toc-number">1.3.3.10.</span> <span class="toc-text">Extra:</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96"><span class="toc-number">2.</span> <span class="toc-text">索引优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">索引分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E8%A1%A8"><span class="toc-number">2.1.1.</span> <span class="toc-text">单表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%A4%E8%A1%A8"><span class="toc-number">2.1.2.</span> <span class="toc-text">两表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E8%A1%A8"><span class="toc-number">2.1.3.</span> <span class="toc-text">三表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-number">2.1.4.</span> <span class="toc-text">结论</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E7%9A%84%E6%83%85%E5%86%B5-%E5%BA%94%E8%AF%A5%E9%81%BF%E5%85%8D"><span class="toc-number">2.1.5.</span> <span class="toc-text">索引失效的情况(应该避免)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E8%88%AC%E6%80%A7%E5%BB%BA%E8%AE%AE"><span class="toc-number">2.1.6.</span> <span class="toc-text">一般性建议:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E6%AD%A5%E9%AA%A4%E6%80%BB%E7%BB%93"><span class="toc-number">2.1.7.</span> <span class="toc-text">优化步骤总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%88%AA%E5%8F%96%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">查询截取分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-number">3.1.</span> <span class="toc-text">查询优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B0%B8%E8%BF%9C%E5%B0%8F%E8%A1%A8%E9%A9%B1%E5%8A%A8%E5%A4%A7%E8%A1%A8-%E7%B1%BB%E4%BC%BC-nested-loop"><span class="toc-number">3.1.1.</span> <span class="toc-text">永远小表驱动大表(类似 nested loop)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#order-by%E4%BC%98%E5%8C%96"><span class="toc-number">3.1.2.</span> <span class="toc-text">order by优化:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Group-by%E4%BC%98%E5%8C%96"><span class="toc-number">3.1.3.</span> <span class="toc-text">Group by优化:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-number">3.2.</span> <span class="toc-text">慢查询日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88-1"><span class="toc-number">3.2.1.</span> <span class="toc-text">是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E7%8E%A9-1"><span class="toc-number">3.2.2.</span> <span class="toc-text">怎么玩</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E7%94%A8%E4%BA%8E%E6%B5%8B%E8%AF%95"><span class="toc-number">3.3.</span> <span class="toc-text">批量创建数据用于测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#show-profile"><span class="toc-number">3.4.</span> <span class="toc-text">show profile</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88-2"><span class="toc-number">3.4.1.</span> <span class="toc-text">是什么:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E6%AD%A5%E9%AA%A4%EF%BC%9A"><span class="toc-number">3.4.2.</span> <span class="toc-text">分析步骤：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-number">3.5.</span> <span class="toc-text">全局查询日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%90%AF%E7%94%A8"><span class="toc-number">3.5.1.</span> <span class="toc-text">配置启用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%90%AF%E7%94%A8"><span class="toc-number">3.5.2.</span> <span class="toc-text">编码启用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B0%B8%E8%BF%9C%E4%B8%8D%E8%A6%81%E5%9C%A8%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%BC%80%E5%90%AF"><span class="toc-number">3.5.3.</span> <span class="toc-text">永远不要在生产环境开启</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E8%88%AC%E7%9A%84%E7%9A%84%E4%BC%98%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="toc-number">3.6.</span> <span class="toc-text">一般的的优化流程</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/4995/" title="顺德好友小聚"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/blog-common.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="顺德好友小聚"/></a><div class="content"><a class="title" href="/posts/4995/" title="顺德好友小聚">顺德好友小聚</a><time datetime="2023-05-07T13:56:00.000Z" title="发表于 2023-05-07 21:56:00">2023-05-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/51438/" title="旅游归来的周末"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/blog-common.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="旅游归来的周末"/></a><div class="content"><a class="title" href="/posts/51438/" title="旅游归来的周末">旅游归来的周末</a><time datetime="2023-05-06T05:56:00.000Z" title="发表于 2023-05-06 13:56:00">2023-05-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/34851/" title="与好友的广西之旅"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/blog-common.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="与好友的广西之旅"/></a><div class="content"><a class="title" href="/posts/34851/" title="与好友的广西之旅">与好友的广西之旅</a><time datetime="2023-05-02T04:30:00.000Z" title="发表于 2023-05-02 12:30:00">2023-05-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/53653/" title="项目管理笔记"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typora%E6%88%AA%E5%B1%8F2022-08-27%2000.25.25.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="项目管理笔记"/></a><div class="content"><a class="title" href="/posts/53653/" title="项目管理笔记">项目管理笔记</a><time datetime="2022-08-28T04:30:00.000Z" title="发表于 2022-08-28 12:30:00">2022-08-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/53652/" title="项目管理笔记"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/blog-common.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="项目管理笔记"/></a><div class="content"><a class="title" href="/posts/53652/" title="项目管理笔记">项目管理笔记</a><time datetime="2022-08-28T04:30:00.000Z" title="发表于 2022-08-28 12:30:00">2022-08-28</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://ytblogpic.oss-cn-guangzhou.aliyuncs.com/typoratimg.jpeg);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By 樱桃先生</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.0</a></span></div><div class="footer_custom_text">一切都是最好的安排</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"></div><div class="aplayer no-destroy" data-id="5225697049" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="false" data-mini="true" data-lrctype="-1"> </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      const usePjax = true
      false
        ? (usePjax ? pjax.loadUrl('/404.html') : window.location.href = '/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>